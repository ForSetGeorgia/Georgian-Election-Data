<% if @table_data.present? && @table_data.data.present? %>
	<% data = @table_data.data %>

    <% default_cols_show = 5 %>

    <div id="data_table_filter_container">
      <select id="data_table_filter" class="event_filter_select chzn-select" multiple>
			  <% @table_data.names.each_with_index do |name, i| %>
	        <%
	          selected = ''
	          if @table_data.selected_id.to_s == @table_data.indicator_ids[i].to_s || i < default_cols_show
	            selected << 'selected="selected"'
	          end

            dataid = @table_data.indicator_ids[i]
            if i == 0 && @table_data.indicator_type_ids.present?
              dataid = 'ind_type_' + @table_data.indicator_type_ids[data[0][i+1]].to_s
            end
	        %>
			    <option <%= selected %> data-id="<%= dataid %>" value="<%= i %>" title="<%= @table_data.desc[i] %>"><%= name %></option>
			  <% end %>
      </select>
    </div>

		<table id="map_data_table" class="table table-striped">
		 <thead>
		  <tr>
		    <% data[0].each_with_index do |value, i| %>
	        <%
	          cls = ''
	          if i > 0 && @table_data.selected_id.to_s == @table_data.indicator_ids[i-1].to_s
	            cls << 'highlighted'
	          end
	          if i > default_cols_show && cls.empty?
	            cls << 'hidden'
	          end

            dataid = 'first_col'
            if i == 1 && @table_data.indicator_type_ids.present?
              dataid = 'ind_type_' + @table_data.indicator_type_ids[data[0][i]].to_s
	          elsif i > 0
	            dataid = @table_data.indicator_ids[i-1]
	          end
	          
	          title = ''
	          if i > 1
	            title = @table_data.desc[i-1]
	          end
	        %>
		      <th data-id="<%= dataid %>" <%= cls.present? ? "class=#{cls}" : '' %> >
		        <span <%= title.present? ? "title='#{title}'".html_safe : '' %>><%= value %></span>
		      </th>
		    <% end %>
		  </tr>
		 </thead>

		 <tbody>
		  <% data[1..(data.length - 1)].each do |row| %>
		    <tr>
		      <% row.each_with_index do |value, i| %>
		        <%
		          cls = ''
		          if i > 0 && @table_data.selected_id.to_s == @table_data.indicator_ids[i-1].to_s
		            cls << 'highlighted '
		          end
		          # only show the first default_cols_show cols
		          if i > default_cols_show && cls.empty?
		            cls << 'hidden '
		          end
		          # if this is winner, highlight it
		          if @table_data.indicator_type_ids.present? && row[1] == data[0][i]
		            cls << 'winner '
		          end
		          
              dataid = 'first_col'
              if i == 1 && @table_data.indicator_type_ids.present?
                dataid = 'ind_type_' + @table_data.indicator_type_ids[data[0][i]].to_s
		          elsif i > 0
		            dataid = @table_data.indicator_ids[i-1]
		          end
		        %>
		        <td data-id="<%= dataid %>" <%= cls.present? ? "class='#{cls}'".html_safe : '' %>>
		          <% if i == 0 %>
		            <span><%= value %></span>
		          <% elsif i == 1 && @table_data.indicator_type_ids.present?%>
		            <%= link_to value, summary_map_path(:event_type_id => params[:event_type_id],
										:event_id => params[:event_id], :shape_type_id => params[:shape_type_id],
										:shape_id => params[:shape_id], :indicator_type_id => @table_data.indicator_type_ids[data[0][i]],
										:view_type => @summary_view_type_name, :custom_view => params[:custom_view],
										:data_type => params[:data_type], :data_set_id => params[:data_set_id],
										:highlight_shape => row[0], :indicator_id => nil) %>
		          <% else %>
		            <%= link_to(value, indicator_map_path(:event_type_id => params[:event_type_id],
										:event_id => params[:event_id], :shape_id => params[:shape_id],
										:shape_type_id => params[:shape_type_id], :indicator_id => @table_data.indicator_ids[i],
										:custom_view => params[:custom_view], :highlight_shape => row[0],
										:data_type => params[:data_type], :data_set_id => params[:data_set_id], 
                    :indicator_type_id => nil)) %>
		          <% end %>
		        </td>
		      <% end %>
		    </tr>
		  <% end %>
		 </tbody>
		</table>


	<script type="text/javascript">
    // create file name for downloads
    var file_name = $('.navmenu-select p').html();

    $(document).ready(function(){
/*
      // if indicator is selected, highlight it in table
      $('table#map_data_table th').removeClass('highlighted');
      $('table#map_data_table td').removeClass('highlighted');
      var ind_id = <%= @table_data.selected_id %>;
      if (ind_id != undefined){
        $('table#map_data_table th[data-id="' + ind_id + '"]').addClass('highlighted');
        $('table#map_data_table td[data-id="' + ind_id + '"]').addClass('highlighted');
      }
*/
      // apply jquery datatable
	    $('#map_data_table').dataTable({
        "sDom": "<'row-fluid'<'span6'f><'span6'T>r>t<'row-fluid'<'span5'i><'span2'l><'span5'p>>",    
        "sPaginationType": "bootstrap",
        "bJQueryUI": false,
        "bProcessing": true,
        "bStateSave": true,
        "bAutoWidth": false,
        "oLanguage": {
          "sUrl": gon.datatable_i18n_url
        },
        "iDisplayLength": 20,
        "aLengthMenu": [[20, 40, 60, 80], [20, 40, 60, 80]],
        "oTableTools": {
			    "aButtons": [
            {
              "sExtends": "csv",
              "sTitle": file_name + " - csv"
            },
            {
              "sExtends": "xls",
              "sTitle": file_name + " - xls"
            }
			    ]
		    }
        
      });
    });
    

	</script>
	<script type="text/javascript" src="/assets/data_table.js"></script>
<% end %>
